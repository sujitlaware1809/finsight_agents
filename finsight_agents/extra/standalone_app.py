from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import os
import logging

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="FinSight AI Agent", version="1.0.0")

class ChatRequest(BaseModel):
    message: str
    user_id: str = "default"

class ChatResponse(BaseModel):
    response: str
    status: str = "success"

# Simple FinSight AI Agent Implementation
class FinSightAIAgent:
    def __init__(self):
        self.name = "finsight-ai-agent"
        self.description = "FinSight AI Financial Advisor - Cloud Ready Version"
    
    def _extract_amount(self, message):
        """Extract monetary amount from message"""
        import re
        # Look for patterns like $300,000 or 300000 or 300k
        patterns = [
            r'\$?([\d,]+(?:\.\d{2})?)',  # $300,000 or 300,000
            r'(\d+)k',  # 300k
            r'(\d+)\s*thousand',  # 300 thousand
            r'(\d+)\s*million',  # 3 million
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, message.lower())
            if matches:
                amount_str = matches[0].replace(',', '')
                try:
                    amount = float(amount_str)
                    if 'k' in message.lower():
                        amount *= 1000
                    elif 'million' in message.lower():
                        amount *= 1000000
                    return amount
                except:
                    continue
        return None
    
    def _extract_age(self, message):
        """Extract age from message"""
        import re
        patterns = [
            r"i'm (\d+)",
            r"i am (\d+)",
            r"(\d+) years old",
            r"age (\d+)",
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, message.lower())
            if matches:
                try:
                    return int(matches[0])
                except:
                    continue
        return None
    
    def _extract_income(self, message):
        """Extract income from message"""
        import re
        patterns = [
            r'earn \$?([\d,]+)',
            r'salary \$?([\d,]+)',
            r'income \$?([\d,]+)',
            r'make \$?([\d,]+)',
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, message.lower())
            if matches:
                try:
                    return float(matches[0].replace(',', ''))
                except:
                    continue
        return None
    
    def _extract_credit_score(self, message):
        """Extract credit score from message"""
        import re
        patterns = [
            r'credit score.*?(\d{3})',
            r'cibil.*?(\d{3})',
            r'score.*?(\d{3})',
        ]
        
        for pattern in patterns:
            matches = re.findall(pattern, message.lower())
            if matches:
                try:
                    score = int(matches[0])
                    if 300 <= score <= 850:  # Valid credit score range
                        return score
                except:
                    continue
        return None
    
    def _calculate_emi(self, principal, annual_rate, years):
        """Calculate EMI for given principal, rate and tenure"""
        monthly_rate = annual_rate / (12 * 100)
        months = years * 12
        if monthly_rate == 0:
            return principal / months
        
        emi = principal * monthly_rate * (1 + monthly_rate)**months / ((1 + monthly_rate)**months - 1)
        return emi
        
    def process_message(self, message):
        """Process user message and return financial advice"""
        msg_lower = message.lower()
        
        # Extract key financial details from message
        loan_amount = self._extract_amount(message)
        age = self._extract_age(message)
        income = self._extract_income(message)
        credit_score = self._extract_credit_score(message)
        
        # Greeting responses
        if any(word in msg_lower for word in ['hello', 'hi', 'hey', 'greet', 'start', 'looking for', 'help me']):
            return f"""
üåü **Welcome to FinSight AI!** üåü

Your comprehensive financial advisor is here to help! I specialize in:

üí∞ **Loan Guidance** - Home, personal, education loans
üìà **Investment Planning** - Mutual funds, stocks, SIPs  
üìã **Tax Optimization** - Filing, deductions, planning
üìä **Credit Score Help** - Improve your CIBIL score
üíπ **Budget Planning** - Smart money management
üõ°Ô∏è **Scam Detection** - Protect your finances
üèõÔ∏è **Government Schemes** - Subsidies and benefits
üí≥ **Credit Card Advice** - Choose and use wisely

**Just ask me anything like:**
‚Ä¢ "I need a home loan for ‚Çπ50 lakhs"
‚Ä¢ "How to invest ‚Çπ10,000 monthly?"
‚Ä¢ "Help me improve my credit score"
‚Ä¢ "Create a budget for ‚Çπ80,000 salary"

What financial guidance can I provide you today? üòä
"""

        # Loan-related queries
        elif any(word in msg_lower for word in ['loan', 'mortgage', 'borrow', 'lending', 'emi']):
            loan_type = "home" if "home" in msg_lower else "personal" if "personal" in msg_lower else "education" if "education" in msg_lower else "general"
            
            response = f"""
üè† **FinSight AI - {loan_type.title()} Loan Advisory** üè†

**Your Loan Request Analysis:**
"""
            
            if loan_amount:
                response += f"‚Ä¢ **Requested Amount:** ${loan_amount:,}\n"
                if loan_amount >= 200000:
                    response += f"‚Ä¢ **Assessment:** Large loan - excellent credit score (750+) recommended\n"
                elif loan_amount >= 50000:
                    response += f"‚Ä¢ **Assessment:** Moderate loan - good credit score (700+) sufficient\n"
                else:
                    response += f"‚Ä¢ **Assessment:** Small loan - fair credit score (650+) acceptable\n"
            
            response += f"""
**Current {loan_type.title()} Loan Rates & Options:**

**üè† Home Loans:**
‚Ä¢ Interest: 8.5% - 9.5% per annum
‚Ä¢ Tenure: Up to 30 years
‚Ä¢ Loan-to-Value: Up to 90%
‚Ä¢ Processing fee: 0.5% - 1%

**üë§ Personal Loans:**
‚Ä¢ Interest: 11% - 24% per annum  
‚Ä¢ Tenure: 1-7 years
‚Ä¢ Amount: ‚Çπ50,000 - ‚Çπ50 lakhs
‚Ä¢ Quick approval (24-48 hours)

**üéì Education Loans:**
‚Ä¢ Interest: 9% - 15% per annum
‚Ä¢ Tenure: Up to 15 years
‚Ä¢ Collateral-free up to ‚Çπ7.5 lakhs
‚Ä¢ Moratorium during study period

**üìã Required Documents:**
‚úÖ Income proof (3 months salary slips)
‚úÖ Bank statements (6 months)
‚úÖ PAN card, Aadhaar card
‚úÖ Property documents (for home loans)
‚úÖ ITR for last 2 years
"""

            if loan_amount:
                monthly_emi = self._calculate_emi(loan_amount, 8.5, 20) if loan_type == "home" else self._calculate_emi(loan_amount, 15, 5)
                response += f"""
**üí∞ EMI Calculation for ${loan_amount:,}:**
‚Ä¢ Estimated Monthly EMI: ${monthly_emi:,.2f}
‚Ä¢ Recommended Monthly Income: ${monthly_emi * 3:,.2f}+
"""

            response += """
**üí° Pro Tips for Better Approval:**
‚Ä¢ Maintain credit score above 750
‚Ä¢ Keep existing EMIs below 40% of income
‚Ä¢ Have stable employment (2+ years)
‚Ä¢ Apply to multiple lenders for best rates

**üéØ Next Steps:**
1. Calculate your EMI affordability
2. Compare rates from 3-4 lenders
3. Get pre-approved before finalizing
4. Negotiate processing fees

Need specific loan amount calculation or eligibility check?
"""
            return response

        # Investment queries
        elif any(word in msg_lower for word in ['invest', 'investment', 'mutual fund', 'sip', 'stock', 'portfolio', 'wealth building']):
            investment_amount = loan_amount if loan_amount else 10000  # Default if no amount specified
            
            response = f"""
üìà **FinSight AI - Investment Strategy for ${investment_amount:,}** üìà

**Your Investment Profile Analysis:**
"""
            
            if age:
                if age < 30:
                    risk_profile = "Aggressive (80% Equity, 20% Debt)"
                    time_horizon = "30+ years for retirement"
                elif age < 40:
                    risk_profile = "Moderate-Aggressive (70% Equity, 30% Debt)"
                    time_horizon = "20+ years for retirement"
                elif age < 50:
                    risk_profile = "Moderate (60% Equity, 40% Debt)"
                    time_horizon = "15+ years for retirement"
                else:
                    risk_profile = "Conservative (40% Equity, 60% Debt)"
                    time_horizon = "10+ years for retirement"
                
                response += f"‚Ä¢ **Age:** {age} years\n"
                response += f"‚Ä¢ **Recommended Risk Profile:** {risk_profile}\n"
                response += f"‚Ä¢ **Investment Horizon:** {time_horizon}\n"
            
            if investment_amount >= 100000:
                response += f"‚Ä¢ **Investment Category:** High-value portfolio\n"
                response += f"‚Ä¢ **Diversification:** 5-7 different funds recommended\n"
            elif investment_amount >= 25000:
                response += f"‚Ä¢ **Investment Category:** Moderate portfolio\n"
                response += f"‚Ä¢ **Diversification:** 3-4 different funds recommended\n"
            else:
                response += f"‚Ä¢ **Investment Category:** Starter portfolio\n"
                response += f"‚Ä¢ **Diversification:** 2-3 different funds recommended\n"

            response += f"""

**üí∞ Strategic Allocation for ${investment_amount:,}:**

**üèÜ Recommended Fund Mix:**
"""

            if age and age < 35:
                response += f"""
‚Ä¢ **Large Cap Funds:** ${int(investment_amount * 0.4):,} (40%) - Stable growth
‚Ä¢ **Mid/Small Cap:** ${int(investment_amount * 0.3):,} (30%) - High growth potential  
‚Ä¢ **International Funds:** ${int(investment_amount * 0.2):,} (20%) - Global exposure
‚Ä¢ **Debt Funds:** ${int(investment_amount * 0.1):,} (10%) - Stability
"""
            else:
                response += f"""
‚Ä¢ **Large Cap Funds:** ${int(investment_amount * 0.5):,} (50%) - Stable growth
‚Ä¢ **Mid Cap Funds:** ${int(investment_amount * 0.2):,} (20%) - Moderate growth
‚Ä¢ **Debt Funds:** ${int(investment_amount * 0.2):,} (20%) - Stability
‚Ä¢ **ELSS (Tax Saving):** ${int(investment_amount * 0.1):,} (10%) - Tax benefits
"""

            monthly_sip = investment_amount / 12
            response += f"""

**ÔøΩ SIP Strategy:**
‚Ä¢ **Monthly SIP Amount:** ${monthly_sip:,.2f}
‚Ä¢ **Expected Annual Return:** 12-15%
‚Ä¢ **10-Year Projected Value:** ${investment_amount * 3.2:,.2f}
‚Ä¢ **20-Year Projected Value:** ${investment_amount * 9.6:,.2f}

**üöÄ Start Your Investment Journey:**
1. **Emergency Fund First:** 6 months expenses
2. **Start SIP:** Automated monthly investments
3. **Step-up SIP:** Increase by 10% annually
4. **Stay Invested:** Don't panic in market dips
5. **Annual Review:** Rebalance if needed

**üì± Recommended Platforms:**
‚Ä¢ Zerodha Coin, Groww, Paytm Money
‚Ä¢ Choose direct plans (lower fees)
‚Ä¢ Set up auto-debit for SIPs

Ready to start your wealth-building journey?
"""
            return response

        # Tax queries
        elif any(word in msg_lower for word in ['tax', 'itr', 'filing', 'deduction', '80c', 'income tax']):
            return """
üìã **FinSight AI - Tax Planning** üìã

**üéØ Key Tax Saving Sections:**

**Section 80C (‚Çπ1.5 Lakh limit):**
‚Ä¢ PPF, EPF contributions
‚Ä¢ ELSS mutual funds
‚Ä¢ Life insurance premiums
‚Ä¢ Principal repayment of home loan
‚Ä¢ NSC, tax-saving FDs

**Section 80D (Medical Insurance):**
‚Ä¢ Self & family: ‚Çπ25,000
‚Ä¢ Parents: ‚Çπ25,000 additional
‚Ä¢ Senior citizens: ‚Çπ50,000

**Section 24 (Home Loan Interest):**
‚Ä¢ Self-occupied: ‚Çπ2 lakh limit
‚Ä¢ Rented property: No limit

**üìù ITR Filing Deadlines:**
‚Ä¢ Salaried: July 31st
‚Ä¢ Business: October 31st
‚Ä¢ Revised return: December 31st

**üí° Smart Tax Planning Tips:**

**For Salaried Employees:**
1. Maximize 80C investments early
2. Claim HRA if paying rent
3. Submit investment proofs to employer
4. Plan medical expenses strategically

**For Freelancers/Business:**
1. Maintain proper expense records
2. Claim home office expenses
3. Professional fees & equipment costs
4. Consider presumptive taxation if eligible

**üö® Common Mistakes to Avoid:**
‚ùå Last-minute tax saving investments
‚ùå Not maintaining expense receipts
‚ùå Missing ITR filing deadline
‚ùå Not claiming all eligible deductions

**üìä Tax Calculation Example:**
Income ‚Çπ10 lakhs ‚Üí Tax ‚Çπ1.17 lakhs
With 80C + 80D savings ‚Üí Tax ‚Çπ70,000
**Savings: ‚Çπ47,000!**

Need help with specific deductions or ITR filing?
"""

        # Credit score queries
        elif any(word in msg_lower for word in ['credit score', 'cibil', 'credit report', 'improve credit']):
            return """
üìä **FinSight AI - Credit Score Mastery** üìä

**üéØ Credit Score Ranges:**
‚Ä¢ **750-900:** Excellent (Best rates)
‚Ä¢ **700-749:** Good (Favorable terms)
‚Ä¢ **650-699:** Fair (Average rates)
‚Ä¢ **Below 650:** Poor (Limited options)

**‚ö° Quick Score Boosters:**

**Immediate Actions (0-30 days):**
‚úÖ Pay all outstanding dues completely
‚úÖ Keep credit utilization below 30%
‚úÖ Set up auto-pay for all bills
‚úÖ Check credit report for errors

**Short-term (1-3 months):**
‚úÖ Pay more than minimum on credit cards
‚úÖ Don't close old credit cards
‚úÖ Avoid new credit applications
‚úÖ Maintain old accounts with small purchases

**Long-term (3+ months):**
‚úÖ Build long credit history
‚úÖ Diversify credit types (cards + loans)
‚úÖ Keep utilization below 10%
‚úÖ Regular monitoring & maintenance

**üö´ Score Killers to Avoid:**
‚ùå Late payments (biggest impact)
‚ùå High credit utilization (>50%)
‚ùå Too many credit inquiries
‚ùå Defaulting on any payment
‚ùå Closing old credit accounts

**üìà Score Improvement Timeline:**
‚Ä¢ **Month 1:** Clear all dues, errors
‚Ä¢ **Month 2:** Optimize utilization
‚Ä¢ **Month 3:** Consistent good behavior
‚Ä¢ **Month 6:** Significant improvement visible

**üÜì Free Credit Report Sources:**
‚Ä¢ CIBIL.com (1 free per year)
‚Ä¢ Paisabazaar, BankBazaar
‚Ä¢ Credit card issuer apps

**üí≥ Credit Building Strategy:**
1. Start with secured credit card if needed
2. Use card for small purchases monthly
3. Pay full amount before due date
4. Gradually build credit limit
5. Add co-applicant if score is very low

Current score range? I can give personalized advice!
"""

        # Budget planning queries
        elif any(word in msg_lower for word in ['budget', 'save', 'savings', 'expense', 'planning', 'money management']):
            return """
üíπ **FinSight AI - Smart Budget Planning** üíπ

**üéØ The 50-30-20 Rule:**
‚Ä¢ **50% Needs:** Rent, groceries, utilities, EMIs
‚Ä¢ **30% Wants:** Entertainment, dining, shopping  
‚Ä¢ **20% Savings:** Emergency fund + investments

**üìä Detailed Budget Breakdown:**

**Fixed Expenses (40-50%):**
‚Ä¢ Rent/Home EMI: 25-30%
‚Ä¢ Insurance premiums: 2-3%
‚Ä¢ Phone, internet, utilities: 3-5%
‚Ä¢ Transportation: 5-10%

**Variable Expenses (25-35%):**
‚Ä¢ Groceries: 8-12%
‚Ä¢ Dining out: 3-5%
‚Ä¢ Entertainment: 3-5%
‚Ä¢ Clothing: 2-3%
‚Ä¢ Miscellaneous: 5-10%

**Savings & Investments (20-25%):**
‚Ä¢ Emergency fund: 5-10%
‚Ä¢ Mutual funds/SIP: 10-15%
‚Ä¢ PPF/ELSS: 3-5%

**üí∞ Smart Saving Strategies:**

**Automated Savings:**
1. Auto-transfer on salary day
2. Separate accounts for different goals
3. Round-up savings apps

**Expense Reduction:**
‚Ä¢ Cook more, eat out less
‚Ä¢ Use public transport/carpooling
‚Ä¢ Cancel unused subscriptions
‚Ä¢ Buy generic brands
‚Ä¢ Plan bulk purchases

**üì± Budget Tracking Tools:**
‚Ä¢ ET Money, Walnut, Money Lover
‚Ä¢ Bank spending analytics
‚Ä¢ Simple Excel/Google Sheets

**üéØ Emergency Fund Goal:**
Build 6-12 months of expenses as priority
Example: Monthly expenses ‚Çπ50,000 ‚Üí Emergency fund ‚Çπ3-6 lakhs

**üìà Budget Example (‚Çπ1 Lakh salary):**
‚Ä¢ Needs: ‚Çπ50,000
‚Ä¢ Wants: ‚Çπ30,000  
‚Ä¢ Savings: ‚Çπ20,000
‚Ä¢ Emergency fund: ‚Çπ10,000
‚Ä¢ Investments: ‚Çπ10,000

What's your monthly income? I'll create a personalized budget!
"""

        # Government schemes
        elif any(word in msg_lower for word in ['government scheme', 'subsidy', 'pmay', 'mudra', 'startup india']):
            return """
üèõÔ∏è **FinSight AI - Government Schemes** üèõÔ∏è

**üè† Housing Schemes:**

**PMAY (Pradhan Mantri Awas Yojana):**
‚Ä¢ Interest subsidy up to ‚Çπ2.67 lakhs
‚Ä¢ Income limit: ‚Çπ6-18 lakhs annually
‚Ä¢ Loan amount: Up to ‚Çπ65 lakhs
‚Ä¢ Apply through banks/PMAY portal

**üíº Business/Startup Schemes:**

**MUDRA Loans:**
‚Ä¢ **Shishu:** Up to ‚Çπ50,000
‚Ä¢ **Kishore:** ‚Çπ50,000 - ‚Çπ5 lakhs  
‚Ä¢ **Tarun:** ‚Çπ5 - ‚Çπ10 lakhs
‚Ä¢ No collateral required

**Startup India:**
‚Ä¢ Tax exemption for 3 years
‚Ä¢ Fast-track patent examination
‚Ä¢ Self-certification compliance
‚Ä¢ Government tender benefits

**üë• Social Security:**

**Atal Pension Yojana (APY):**
‚Ä¢ Monthly pension ‚Çπ1,000-5,000
‚Ä¢ Government co-contribution
‚Ä¢ Entry age: 18-40 years

**PMJJBY & PMSBY:**
‚Ä¢ Life insurance: ‚Çπ2 lakhs for ‚Çπ330/year
‚Ä¢ Accident insurance: ‚Çπ2 lakhs for ‚Çπ20/year

**üë© Women-Specific Schemes:**

**Sukanya Samriddhi Yojana:**
‚Ä¢ Girl child savings scheme
‚Ä¢ Interest rate: ~7.6%
‚Ä¢ Tax benefits under 80C
‚Ä¢ Maturity: 21 years

**Stand-up India:**
‚Ä¢ Bank loans ‚Çπ10 lakh - ‚Çπ1 crore
‚Ä¢ For SC/ST/Women entrepreneurs
‚Ä¢ Handholding support included

**üìö Education Schemes:**
‚Ä¢ Interest subsidy on education loans
‚Ä¢ Merit scholarships
‚Ä¢ Skill development programs

**‚úÖ How to Apply:**
1. Visit official government portals
2. Check eligibility criteria carefully
3. Prepare required documents
4. Apply online or through banks
5. Track application status regularly

**üö® Avoid Middlemen:**
Always apply directly through official channels!

Which specific scheme interests you most?
"""

        # Scam detection
        elif any(word in msg_lower for word in ['scam', 'fraud', 'suspicious', 'lottery', 'prize', 'fake']):
            return """
üõ°Ô∏è **FinSight AI - Scam Alert & Protection** üõ°Ô∏è

**üö® Top Financial Scams to Watch Out For:**

**üìû Phone/SMS Scams:**
‚ùå "Congratulations! You've won ‚Çπ25 lakhs"
‚ùå "Your account will be blocked, share OTP"
‚ùå "KYC update required immediately"
‚ùå "Get loan instantly, pay processing fee"

**üí≥ Banking Frauds:**
‚ùå Fake bank websites/apps
‚ùå Phishing emails requesting login details
‚ùå UPI payment reversals scam
‚ùå ATM skimming devices

**üìà Investment Scams:**
‚ùå "Guaranteed 50% returns in 6 months"
‚ùå Ponzi schemes (early investors paid from new money)
‚ùå Fake cryptocurrency platforms
‚ùå Binary trading scams

**üö© Universal Red Flags:**
‚Ä¢ Unsolicited calls/messages
‚Ä¢ Pressure to act immediately  
‚Ä¢ "Too good to be true" offers
‚Ä¢ Requests for upfront payments
‚Ä¢ Asking for OTP/PIN/passwords
‚Ä¢ Poor grammar in communications

**‚úÖ Protection Strategies:**

**Never Share:**
‚Ä¢ OTP, PIN, CVV numbers
‚Ä¢ Net banking credentials  
‚Ä¢ Credit/debit card details
‚Ä¢ Aadhaar/PAN numbers over phone

**Always Verify:**
‚Ä¢ Call bank's official number independently
‚Ä¢ Check company registration online
‚Ä¢ Consult family/friends before investing
‚Ä¢ Research investment schemes thoroughly

**üì± Safety Checklist:**
‚úÖ Use official apps only
‚úÖ Enable 2-factor authentication
‚úÖ Regular account monitoring
‚úÖ Set transaction limits
‚úÖ Keep software updated

**üÜò If You're Scammed:**
1. **Immediately:** Block cards, change passwords
2. **Report:** Police, bank, cybercrime.gov.in
3. **Document:** Save all communications
4. **Follow-up:** Track complaint status

**üìû Emergency Numbers:**
‚Ä¢ Cyber Crime: 1930
‚Ä¢ Banking Ombudsman: 14448
‚Ä¢ National Helpline: 155260

**üí° Remember:** 
Legitimate institutions NEVER ask for sensitive info over phone/email!

Describe any suspicious activity you've encountered for specific advice.
"""

        # Credit card queries  
        elif any(word in msg_lower for word in ['credit card', 'card', 'cashback', 'rewards']):
            return """
üí≥ **FinSight AI - Credit Card Mastery** üí≥

**üèÜ Best Credit Cards by Category:**

**üí∞ Cashback Cards:**
‚Ä¢ **HDFC MoneyBack:** 5% cashback online
‚Ä¢ **SBI SimplyCLICK:** 10X rewards online
‚Ä¢ **ICICI Amazon Pay:** Unlimited 1% cashback

**‚úàÔ∏è Travel Cards:**
‚Ä¢ **Axis Magnus:** 12 reward points per ‚Çπ200
‚Ä¢ **HDFC Diners Black:** Airport lounge access
‚Ä¢ **Amex Gold:** 4X points on dining

**‚õΩ Fuel Cards:**
‚Ä¢ **HDFC IOCL:** 5% cashback on fuel
‚Ä¢ **SBI BPCL:** 13X reward points

**üõçÔ∏è Lifestyle Cards:**
‚Ä¢ **HDFC Regalia:** Premium dining benefits
‚Ä¢ **ICICI Coral:** Movies & dining rewards

**üìä Card Selection Criteria:**

**For Beginners:**
‚Ä¢ Annual fee: ‚Çπ0-500
‚Ä¢ Easy approval (salary ‚Çπ25,000+)
‚Ä¢ Basic rewards (1-2%)
‚Ä¢ Simple terms & conditions

**For Experienced Users:**
‚Ä¢ Higher reward rates (5-10%)
‚Ä¢ Premium benefits (lounge, insurance)
‚Ä¢ Annual fee justified by benefits

**üí° Smart Usage Tips:**

**Maximize Rewards:**
‚úÖ Use right card for right category
‚úÖ Pay bills to earn rewards
‚úÖ Time purchases for bonus offers
‚úÖ Redeem rewards regularly

**Avoid Pitfalls:**
‚ùå Cash advances (high interest)
‚ùå Only minimum payments
‚ùå Overspending for rewards
‚ùå Missing due dates

**üì± Application Process:**
1. Check eligibility online
2. Compare offers across banks
3. Apply for pre-approved cards first
4. Submit income documents
5. Wait for approval (3-7 days)

**üéØ Monthly Management:**
‚Ä¢ Set spending alerts
‚Ä¢ Pay full amount by due date
‚Ä¢ Review statements for errors
‚Ä¢ Keep utilization below 30%

**üí≥ Ideal Card Portfolio:**
‚Ä¢ 1 Cashback card for daily spending
‚Ä¢ 1 Travel card for booking trips
‚Ä¢ 1 Fuel card if you drive regularly

What's your primary use case and monthly spending pattern?
"""

        # Default response for other queries
        else:
            return f"""
ü§ñ **FinSight AI - Financial Guidance** ü§ñ

I understand you're asking about: "{message}"

I'm here to help with comprehensive financial advice! Let me guide you to the right information:

**üéØ I can help you with:**

üí∞ **Loan Guidance:** "I need a home loan" or "personal loan advice"
üìà **Investment Planning:** "How to invest money" or "mutual fund advice"  
üìã **Tax Help:** "Tax filing help" or "tax saving tips"
üìä **Credit Score:** "Improve credit score" or "CIBIL score help"
üíπ **Budget Planning:** "Create a budget" or "saving money tips"
üõ°Ô∏è **Scam Protection:** "Is this a scam?" or "fraud detection"
üèõÔ∏è **Government Schemes:** "PMAY scheme" or "government subsidies"
üí≥ **Credit Cards:** "Best credit card" or "card recommendations"

**üìù Try asking:**
‚Ä¢ "I want to buy a house, help with home loan"
‚Ä¢ "Best way to invest ‚Çπ50,000?"
‚Ä¢ "How to save tax this year?"
‚Ä¢ "My credit score is 650, how to improve?"

**üéØ For Best Results:**
Include specific details like:
- Your income range
- Investment amount  
- Specific goals
- Timeline

What specific financial topic would you like detailed guidance on? üí°
"""

# Initialize the agent
financial_agent = FinSightAIAgent()
logger.info(f"FinSight AI Agent initialized: {financial_agent.name}")

@app.get("/")
def health_check():
    return {
        "status": "healthy",
        "agent": financial_agent.name,
        "message": "FinSight AI Agent is running successfully!"
    }

@app.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    try:
        # Process the message through the agent
        response = financial_agent.process_message(request.message)
        return ChatResponse(response=response)
    except Exception as e:
        logger.error(f"Error processing request: {e}")
        raise HTTPException(status_code=500, detail=f"Error processing request: {str(e)}")

@app.get("/agent-info")
def agent_info():
    return {
        "name": financial_agent.name,
        "description": financial_agent.description,
        "status": "active",
        "capabilities": [
            "Loan Guidance",
            "Investment Planning", 
            "Tax Assistance",
            "Credit Score Help",
            "Budget Planning",
            "Scam Detection",
            "Government Schemes",
            "Credit Card Advice"
        ]
    }

if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 8080))
    uvicorn.run("standalone_app:app", host="0.0.0.0", port=port)
